<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞–≥—Ä—É–∑–∫–∞...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a0a14;
      --bg-secondary: #12121f;
      --bg-card: #1a1a2e;
      --bg-hover: #252540;
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      --accent: #667eea;
      --accent-light: #a5b4fc;
      --green: #4ade80;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.5;
    }
    
    a { color: inherit; text-decoration: none; }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 64px;
    }
    
    .logo {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent) 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .nav { display: flex; gap: 30px; }
    .nav a { color: var(--text-secondary); font-size: 15px; font-weight: 500; transition: color 0.2s; }
    .nav a:hover { color: var(--text-primary); }
    
    .header-actions { display: flex; align-items: center; gap: 15px; }
    
    .city-select {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
      font-size: 18px;
      color: var(--text-muted);
    }
    
    .error-page {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 60vh;
      text-align: center;
      padding: 20px;
    }
    .error-page h1 { font-size: 64px; margin-bottom: 20px; color: var(--accent); }
    .error-page p { color: var(--text-muted); }
    
    .event-page { display: none; }
    
    .breadcrumbs {
      padding: 15px 0;
      font-size: 13px;
      color: var(--text-muted);
    }
    .breadcrumbs a { color: var(--accent-light); }
    .breadcrumbs span { margin: 0 8px; }
    
    .event-layout {
      display: grid;
      grid-template-columns: 300px 1fr 350px;
      gap: 30px;
      padding: 20px 0 60px;
    }
    
    .event-poster {
      position: sticky;
      top: 84px;
      height: fit-content;
    }
    
    .poster-box {
      width: 100%;
      aspect-ratio: 3/4;
      background: var(--bg-card);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    
    .poster-box img { width: 100%; height: 100%; object-fit: cover; }
    
    .event-rating {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      padding: 12px;
      background: var(--bg-card);
      border-radius: 10px;
    }
    .rating-score { font-size: 24px; font-weight: 700; color: var(--green); }
    .rating-text { color: var(--text-muted); font-size: 13px; }
    
    .event-main { min-width: 0; }
    
    .event-category {
      display: inline-block;
      background: rgba(102, 126, 234, 0.2);
      color: var(--accent-light);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 15px;
    }
    
    .event-title {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 20px;
      line-height: 1.2;
    }
    
    .event-meta-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .meta-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 15px;
      background: var(--bg-card);
      border-radius: 12px;
    }
    .meta-icon { font-size: 24px; }
    .meta-content {}
    .meta-label { font-size: 12px; color: var(--text-muted); margin-bottom: 3px; }
    .meta-value { font-size: 15px; font-weight: 500; }
    
    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .event-description {
      color: var(--text-secondary);
      line-height: 1.8;
      margin-bottom: 30px;
    }
    
    .venue-section {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 30px;
    }
    
    .venue-name { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
    .venue-address { color: var(--text-muted); font-size: 14px; margin-bottom: 15px; }
    .venue-map {
      height: 200px;
      background: var(--bg-hover);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }
    
    .order-sidebar {
      position: sticky;
      top: 84px;
      height: fit-content;
    }
    
    .order-box {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 16px;
      padding: 25px;
    }
    
    .order-box h2 { font-size: 18px; margin-bottom: 20px; text-align: center; }
    
    .price-display {
      text-align: center;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .price-label { color: var(--text-muted); font-size: 13px; margin-bottom: 5px; }
    .price-value { font-size: 32px; font-weight: 700; color: var(--green); }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); }
    .form-group input::placeholder { color: rgba(255,255,255,0.3); }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      margin: 20px 0;
    }
    .total-label { color: var(--text-muted); font-size: 14px; }
    .total-amount { font-size: 22px; font-weight: 700; color: var(--green); }
    
    .submit-btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .seats-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
      padding: 10px;
      background: rgba(74, 222, 128, 0.1);
      border-radius: 8px;
      color: var(--green);
      font-size: 13px;
    }
    .seats-badge.low { background: rgba(251, 146, 60, 0.1); color: #fb923c; }
    
    .sold-out {
      text-align: center;
      padding: 30px;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.2);
      border-radius: 14px;
    }
    .sold-out h2 { color: #f87171; margin-bottom: 10px; }
    
    .footer {
      background: var(--bg-secondary);
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 40px 0;
      margin-top: 60px;
    }
    .footer-inner { display: flex; justify-content: space-between; align-items: center; }
    .footer-links { display: flex; gap: 30px; }
    .footer-links a { color: var(--text-muted); font-size: 14px; }
    .footer-links a:hover { color: var(--text-primary); }
    .footer-copy { color: var(--text-muted); font-size: 13px; }
    
    @media (max-width: 1000px) {
      .event-layout { grid-template-columns: 1fr; }
      .event-poster { position: static; max-width: 300px; margin: 0 auto; }
      .order-sidebar { position: static; }
      .nav { display: none; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <a href="/" class="logo">–ë–ò–õ–ï–¢–ò–ö–°</a>
      <nav class="nav">
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="/#concerts">–ö–æ–Ω—Ü–µ—Ä—Ç—ã</a>
        <a href="/#theatre">–¢–µ–∞—Ç—Ä</a>
        <a href="/#exhibitions">–í—ã—Å—Ç–∞–≤–∫–∏</a>
        <a href="/#kids">–î–µ—Ç—è–º</a>
      </nav>
      <div class="header-actions">
        <button class="city-select">
          <span>üìç</span>
          <span id="headerCity">–ú–æ—Å–∫–≤–∞</span>
        </button>
      </div>
    </div>
  </header>

  <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  
  <div class="error-page" id="errorPage">
    <h1>404</h1>
    <p>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
    <a href="/" style="margin-top: 20px; color: var(--accent-light);">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>

  <div class="event-page" id="eventPage">
    <div class="container">
      <div class="breadcrumbs">
        <a href="/">–ì–ª–∞–≤–Ω–∞—è</a>
        <span>‚Ä∫</span>
        <a href="/" id="breadCategory">–ö–æ–Ω—Ü–µ—Ä—Ç—ã</a>
        <span>‚Ä∫</span>
        <span id="breadTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</span>
      </div>
      
      <div class="event-layout">
        <div class="event-poster">
          <div class="poster-box" id="posterBox">
            <img id="posterImage" src="" alt="">
          </div>
          <div class="event-rating">
            <span class="rating-score" id="ratingScore">8.5</span>
            <span class="rating-text">—Ä–µ–π—Ç–∏–Ω–≥<br>–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
          </div>
        </div>
        
        <div class="event-main">
          <span class="event-category" id="categoryTag"></span>
          <h1 class="event-title" id="eventTitle"></h1>
          
          <div class="event-meta-grid">
            <div class="meta-item">
              <span class="meta-icon">üìÖ</span>
              <div class="meta-content">
                <div class="meta-label">–î–∞—Ç–∞</div>
                <div class="meta-value" id="metaDate"></div>
              </div>
            </div>
            <div class="meta-item">
              <span class="meta-icon">‚è∞</span>
              <div class="meta-content">
                <div class="meta-label">–í—Ä–µ–º—è</div>
                <div class="meta-value" id="metaTime"></div>
              </div>
            </div>
            <div class="meta-item">
              <span class="meta-icon">üìç</span>
              <div class="meta-content">
                <div class="meta-label">–ì–æ—Ä–æ–¥</div>
                <div class="meta-value" id="metaCity"></div>
              </div>
            </div>
            <div class="meta-item">
              <span class="meta-icon">üéüÔ∏è</span>
              <div class="meta-content">
                <div class="meta-label">–í–æ–∑—Ä–∞—Å—Ç</div>
                <div class="meta-value">12+</div>
              </div>
            </div>
          </div>
          
          <div class="description-section">
            <h3 class="section-title">–û –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</h3>
            <p class="event-description" id="eventDescription"></p>
          </div>
          
          <div class="venue-section">
            <h3 class="section-title" style="border: none; padding: 0; margin-bottom: 15px;">–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è</h3>
            <div class="venue-name" id="venueName">–ö–æ–Ω—Ü–µ—Ä—Ç–Ω—ã–π –∑–∞–ª</div>
            <div class="venue-address" id="venueAddress"></div>
            <div class="venue-map">üó∫Ô∏è –ö–∞—Ä—Ç–∞</div>
          </div>
        </div>
        
        <div class="order-sidebar">
          <div class="order-box" id="orderBox">
            <h2>–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç</h2>
            
            <div class="price-display">
              <div class="price-label">–¶–µ–Ω–∞ –±–∏–ª–µ—Ç–∞</div>
              <div class="price-value" id="priceDisplay">0 ‚ÇΩ</div>
            </div>
            
            <form id="orderForm" onsubmit="submitOrder(event)">
              <div class="form-group">
                <label>–í–∞—à–µ –∏–º—è</label>
                <input type="text" id="customerName" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" minlength="2">
              </div>
              <div class="form-group">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="customerPhone" required placeholder="+7 999 123 4567">
              </div>
              <div class="form-group">
                <label>Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="email" id="customerEmail" placeholder="email@example.com">
              </div>
              <div class="form-group">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∏–ª–µ—Ç–æ–≤</label>
                <select id="seatsCount" onchange="updateTotal()"></select>
              </div>
              <div class="total-row">
                <span class="total-label">–ò—Ç–æ–≥–æ:</span>
                <span class="total-amount" id="totalAmount">0 ‚ÇΩ</span>
              </div>
              <button type="submit" class="submit-btn" id="submitBtn">–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç</button>
            </form>
            
            <div class="seats-badge" id="seatsBadge">
              <span>üé´</span>
              <span id="seatsLeft">–û—Å—Ç–∞–ª–æ—Å—å 0 –º–µ—Å—Ç</span>
            </div>
          </div>
          
          <div class="sold-out" id="soldOut" style="display: none;">
            <h2>–ë–∏–ª–µ—Ç—ã —Ä–∞—Å–ø—Ä–æ–¥–∞–Ω—ã</h2>
            <p style="color: var(--text-muted);">–í—Å–µ –º–µ—Å—Ç–∞ —É–∂–µ –∑–∞–Ω—è—Ç—ã</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container footer-inner">
      <div class="footer-links">
        <a href="#">–û –Ω–∞—Å</a>
        <a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a>
        <a href="#">–ü–æ–º–æ—â—å</a>
        <a href="#">–†–µ–∫–ª–∞–º–∞</a>
      </div>
      <div class="footer-copy">¬© 2025 –ë–∏–ª–µ—Ç–∏–∫—Å. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</div>
    </div>
  </footer>

  <script>
    let eventData = null;
    let eventSlug = null;

    async function init() {
      const pathParts = window.location.pathname.split('/');
      eventSlug = pathParts[pathParts.length - 1];
      
      if (!eventSlug) {
        showError();
        return;
      }

      try {
        const res = await fetch(`/api/e/${eventSlug}`);
        if (!res.ok) {
          showError();
          return;
        }
        eventData = await res.json();
        if (!eventData || eventData.error) {
          showError();
          return;
        }
        renderEvent();
      } catch (err) {
        console.error('Error:', err);
        showError();
      }
    }

    function showError() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('errorPage').style.display = 'flex';
    }

    function renderEvent() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('eventPage').style.display = 'block';
      document.title = eventData.name + ' ‚Äî –ë–∏–ª–µ—Ç–∏–∫—Å';

      if (eventData.coverImageUrl) {
        document.getElementById('posterImage').src = eventData.coverImageUrl;
      } else {
        document.getElementById('posterBox').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
      }

      document.getElementById('categoryTag').textContent = eventData.categoryName;
      document.getElementById('eventTitle').textContent = eventData.name;
      document.getElementById('breadCategory').textContent = eventData.categoryName;
      document.getElementById('breadTitle').textContent = eventData.name;
      
      document.getElementById('metaDate').textContent = formatDate(eventData.date);
      document.getElementById('metaTime').textContent = eventData.time?.slice(0,5) || '19:00';
      document.getElementById('metaCity').textContent = eventData.cityName;
      document.getElementById('headerCity').textContent = eventData.cityName;
      
      document.getElementById('priceDisplay').textContent = eventData.price.toLocaleString() + ' ‚ÇΩ';
      
      document.getElementById('ratingScore').textContent = (7.5 + Math.random() * 2).toFixed(1);
      
      if (eventData.description) {
        document.getElementById('eventDescription').textContent = eventData.description;
      } else {
        document.getElementById('eventDescription').textContent = '–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.';
      }
      
      document.getElementById('venueName').textContent = eventData.categoryName === '–ö–æ–Ω—Ü–µ—Ä—Ç—ã' ? '–ö–æ–Ω—Ü–µ—Ä—Ç–Ω—ã–π –∑–∞–ª' : '–ü–ª–æ—â–∞–¥–∫–∞';
      document.getElementById('venueAddress').textContent = eventData.cityName + ', —Ü–µ–Ω—Ç—Ä –≥–æ—Ä–æ–¥–∞';

      if (eventData.availableSeats <= 0) {
        document.getElementById('orderBox').style.display = 'none';
        document.getElementById('soldOut').style.display = 'block';
      } else {
        const seatsSelect = document.getElementById('seatsCount');
        const maxSeats = Math.min(eventData.availableSeats, 10);
        seatsSelect.innerHTML = '';
        for (let i = 1; i <= maxSeats; i++) {
          seatsSelect.innerHTML += `<option value="${i}">${i}</option>`;
        }
        updateTotal();
        
        const badge = document.getElementById('seatsBadge');
        document.getElementById('seatsLeft').textContent = `–û—Å—Ç–∞–ª–æ—Å—å ${eventData.availableSeats} –º–µ—Å—Ç`;
        if (eventData.availableSeats < 10) {
          badge.classList.add('low');
        }
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    function updateTotal() {
      const seats = parseInt(document.getElementById('seatsCount').value) || 1;
      const total = seats * eventData.price;
      document.getElementById('totalAmount').textContent = total.toLocaleString() + ' ‚ÇΩ';
    }

    async function submitOrder(e) {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      btn.disabled = true;
      btn.textContent = '–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ...';

      const data = {
        eventSlug: eventSlug,
        customerName: document.getElementById('customerName').value,
        customerPhone: document.getElementById('customerPhone').value,
        customerEmail: document.getElementById('customerEmail').value || undefined,
        seatsCount: parseInt(document.getElementById('seatsCount').value)
      };

      try {
        const res = await fetch('/api/create-ticket-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        
        if (result.success) {
          window.location.href = '/pay?order=' + result.orderCode;
        } else {
          alert(result.message || '–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞');
          btn.disabled = false;
          btn.textContent = '–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç';
        }
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        btn.disabled = false;
        btn.textContent = '–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç';
      }
    }

    init();
  </script>
</body>
</html>
